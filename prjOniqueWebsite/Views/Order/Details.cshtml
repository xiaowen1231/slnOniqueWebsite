@{
    ViewData["Title"] = "訂單內容";
    Layout = "~/Views/Shared/_Layout_Background.cshtml";
    int orderId = @ViewBag.orderId;

}


<div class="container  rounded my-2">
    <div class="fs-3 fw-bold text-center border-bottom border-dark-subtle p-3">訂單明細</div>
    <div id="shippingDetail">

        <input type="hidden" id="orderId" value="@orderId" />
        @*<div class="shadow-sm p-3 m-3 rounded d-flex gap-2 justify-content-between bg-body-tertiary border">
        <div class="d-flex gap-3 p-1">
        <div class="d-flex gap-2 align-items-center">
        <img src="../Images/ManagerPhoto/範例頭貼1.jpg" alt="" class="circle-size-60 cover">
        <div class="fw-bold fs-5"> Aki</div>
        </div>
        <div class="d-flex gap-2 align-items-center">
        <div class="fw-bold">訂單編號 : </div>
        <div class="text-danger">OrderNum001</div>
        </div>
        </div>
        <div>
        <div class="d-flex gap-2">
        <div class="fw-bold">下單日期 : </div>
        <div>2023/07/16 17:14</div>
        </div>
        <div class="d-flex gap-2">
        <div class="fw-bold">出貨日期 : </div>
        <div class="text-secondary">未出貨</div>
        </div>
        <div class="d-flex gap-2">
        <div class="fw-bold">完成日期 : </div>
        <div class="text-secondary">未完成</div>
        </div>
        </div>
        </div>

        <div class="shadow-sm p-3 m-3 bg-body-tertiary rounded border">
        <div class="m-2">
        <div class="d-flex gap-2 align-items-center">
        <div class="fw-bold width-90px text-end">訂單狀態 : </div>
        <div class="text-danger">待出貨</div>
        </div>
        </div>
        <div class="m-2">
        <div class="d-flex gap-2 align-items-center">
        <div class="fw-bold width-90px text-end">運送方式 : </div>
        <div>便利商店</div>
        </div>
        </div>
        <div class="m-2">
        <div class="d-flex gap-2 align-items-center">
        <div class="fw-bold width-90px text-end">付款方式 : </div>
        <div>貨到付款</div>
        </div>
        </div>
        <div class="m-2">
        <div class="d-flex gap-2 align-items-center">
        <div class="fw-bold width-90px text-end">收件人 : </div>
        <div>Aki</div>
        </div>
        </div>
        <div class="m-2">
        <div class="d-flex gap-2 align-items-center">
        <div class="fw-bold width-90px text-end">連絡電話 : </div>
        <div>0912345678</div>
        </div>
        </div>
        <div class="m-2">
        <div class="d-flex gap-2 align-items-center">
        <div class="fw-bold width-90px text-end">運送地址 : </div>
        <div>台北市復興南路一段390號2樓</div>
        </div>
        </div>
        </div>*@
    </div>
    <div class="shadow-sm p-3 m-3 bg-body-tertiary rounded border">
        <span class="fw-bold fs-5">訂單商品明細</span>
        <div class="my-2">
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th>商品照片</th>
                        <th>商品名稱</th>
                        <th>價格</th>
                        <th>數量</th>
                        <th>尺寸</th>
                        <th>顏色</th>
                        <th>小計</th>
                    </tr>
                </thead>


                <tbody id="orderProductList">
                    @*<tr>
                    <td>
                    <img src="../Images/Product/丹寧亨利領襯衫.jpg" alt="" class="width-120px cover">
                    </td>
                    <td>丹寧亨利領襯衫</td>
                    <td>980</td>
                    <td>2</td>
                    <td>L</td>
                    <td>藍色</td>
                    <td>
                    <span>$</span>
                    <span class="text-danger">1960</span>
                    </td>
                    </tr>
                    <tr>
                    <td>
                    <img src="../Images/Product/不規則條紋上衣.jpg" alt="" class="width-120px cover">
                    </td>
                    <td>不規則條紋上衣</td>
                    <td>700</td>
                    <td>3</td>
                    <td>m</td>
                    <td>棕色</td>
                    <td>
                    <span>$</span>
                    <span class="text-danger">2100</span>
                    </td>
                    </tr>*@
                </tbody>



            </table>
        </div>
        <div class="border rounded my-4 border-dark-subtle p-2 ">
            <div class=" p-2 my-2 d-flex">
                <div class=" fw-bold" style="width: 95px;"><span class="dollar">商品總額</span></div>
                <div class=" text-end" style="width: 95px;"><span id="productTotal"></span></div>
            </div>
            <div class="p-2 my-2">
                <div class="d-flex ">
                    <div class="fw-bold" style="width: 95px;"><span class="dollar">運送費用</span></div>
                    <div class="text-end " style="width: 95px;"><span id="shippingfee">60</span></div>
                </div>
            </div>
            <div class="p-2 my-2">
                <div class="d-flex ">
                    <div class="fw-bold lh-lg" style="width: 95px;"><span class="dollar">應付總額</span></div>
                    <div class="text-end text-danger fw-bold fs-5 " style="width: 95px;"><span id="total"></span></div>
                </div>
            </div>
        </div>
        <div class="p-2 rounded color-fff border">
            <div class="d-flex p-3 fw-bold ">
                <div>目前訂單狀態</div>
                <div class="fs-6 mx-3 text-danger" id="orderStatusNow"></div>
            </div>

            <div class="p-2">
                <div class="p-2 fw-bold">
                    <span>修改訂單狀態</span>
                </div>
                <div>
                    <select class="form-select d-inline w-25" id="statusSel" aria-label="訂單狀態">
                        @*<option value="" selected="selected">未選擇</option>
                        <option value="">待出貨</option>
                        <option value="">已出貨</option>
                        <option value="">已完成</option>
                        <option value="">已取消</option>
                        <option value="">退款中</option>
                        <option value="">已退款</option>
                        <option value="">未取貨</option>*@
                    </select>
                </div>
            </div>
            <div class="m-3 text-center">
                @Html.ActionLink("返回訂單管理", "index","order", "",new {@class="btn btn-outline-dark" })
                <input type="submit" value="確認修改訂單" class="btn btn-outline-danger">
            </div>
        </div>
    </div>
</div>



@section Scripts{
    <script>
        const productListTable = document.querySelector("#orderProductList")
        const shippingDetailTable = document.querySelector("#shippingDetail")
        const productPrice = document.querySelector("#productTotal")
        const totalprice = document.querySelector("#total")
        const orderStatusNow = document.querySelector("#orderStatusNow")
        const statusSel = document.querySelector("#statusSel")
        let total = 0;



        async function loadOrderProductList() {
            const orderId = $("#orderId").val()
            const response = await fetch(`@Url.Content("~/OrderApi/orderProductDetail?orderId=")${orderId}`)
            const data = await response.json();
            const productList = data.map(prod => {
                const { productName, sizeName, colorName, orderQuantity, price, photoPath } = prod
                let subtotal = orderQuantity * price;
                total += subtotal
                //photoPath = photoPath == null ? default : photoPath
                //console.log(productName, sizeName, colorName, orderQuantity, price, photoPath)
                return (`<tr>
                                                                    <td>
                                                                    <img src="@Url.Content("~/images/uploads/products/")${photoPath}" alt="" class="width-120px cover">
                                                                    </td>
                                                                    <td>${productName}</td>
                                                                    <td>${price}</td>
                                                                    <td>${orderQuantity}</td>
                                                                    <td>${sizeName}</td>
                                                                    <td>${colorName}</td>
                                                                    <td>
                                                                    <span class="dollar text-danger">${subtotal}</span>
                                                                    </td>
                                                                    </tr>
                                                                    `
                )
            })
            productListTable.innerHTML = productList.join("");
            productPrice.innerHTML = total;
            totalprice.innerHTML = total + 60;
        }



        async function loadShippingDetail() {
            const orderId = $("#orderId").val()
            const response = await fetch(`@Url.Content("~/OrderApi/orderShippingDetail?OrderId=")${orderId}`)
            const data = await response.json()
            let { statusName, methodName, paymentMethodName, name, phone, photoPath, shippingAddress,
                orderDate, shippingDate, completionDate } = data

            orderDate = orderDate.substring(0, 10) + " " + orderDate.substring(11, 19)
            shippingDate = shippingDate.substring(0, 10) + " " + shippingDate.substring(11, 19)
            completionDate = completionDate == null ? "訂單尚未完成" : completionDate;
            completionDate = completionDate.substring(0, 10) + " " + completionDate.substring(11, 19)


            shippingDetail =
                `
                                                                            <div class="shadow-sm p-3 m-3 rounded d-flex gap-2 justify-content-between bg-body-tertiary border">
                                                                                        <div class="d-flex gap-3 p-1">
                                                                                            <div class="d-flex gap-2 align-items-center">
                                                                                                    <img src="@Url.Content("~/images/uploads/members/")${photoPath}" alt="" class="circle-size-60 cover">
                                                                                                    <div class="fw-bold fs-5">${name}</div>
                                                                                            </div>
                                                                                        <div class="d-flex gap-2 align-items-center">
                                                                                            <div class="fw-bold">訂單編號</div>
                                                                                            <div class="text-danger">${orderId}</div>
                                                                                        </div>
                                                                                        </div>
                                                                                    <div>
                                                                                        <div class="d-flex gap-2">
                                                                                            <div class="fw-bold">下單日期 : </div>
                                                                                                    <div>${orderDate}</div>
                                                                                        </div>
                                                                                        <div class="d-flex gap-2">
                                                                                            <div class="fw-bold">出貨日期 : </div>
                                                                                            <div class="text-secondary">${shippingDate}</div>
                                                                                        </div>
                                                                                        <div class="d-flex gap-2">
                                                                                            <div class="fw-bold">完成日期 : </div>
                                                                                                    <div class="text-secondary">${completionDate}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                    </div>

                                                                                <div class="shadow-sm p-3 m-3 bg-body-tertiary rounded border">
                                                                                    <div class="m-2">
                                                                                        <div class="d-flex gap-2 align-items-center">
                                                                                            <div class="fw-bold width-90px text-end">訂單狀態 : </div>
                                                                                                    <div class="text-danger">${statusName}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="m-2">
                                                                                        <div class="d-flex gap-2 align-items-center">
                                                                                            <div class="fw-bold width-90px text-end">運送方式 : </div>
                                                                                                    <div>${methodName}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="m-2">
                                                                                        <div class="d-flex gap-2 align-items-center">
                                                                                            <div class="fw-bold width-90px text-end">付款方式 : </div>
                                                                                                    <div>${paymentMethodName}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="m-2">
                                                                                        <div class="d-flex gap-2 align-items-center">
                                                                                            <div class="fw-bold width-90px text-end">收件人 : </div>
                                                                                                    <div>${name}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="m-2">
                                                                                        <div class="d-flex gap-2 align-items-center">
                                                                                            <div class="fw-bold width-90px text-end">連絡電話 : </div>
                                                                                                    <div>${phone}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="m-2">
                                                                                        <div class="d-flex gap-2 align-items-center">
                                                                                            <div class="fw-bold width-90px text-end">運送地址 : </div>
                                                                                            <div>${shippingAddress}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                    `

            shippingDetailTable.innerHTML = shippingDetail;
        }

        loadOrderProductList();
        loadShippingDetail();

        async function loadStatusNow() {
            const orderId = $("#orderId").val()
            const response = await fetch(`@Url.Content("~/OrderApi/OrderStatusNow?OrderId=")${orderId}`)
            const data = await response.json()
            let { statusName, statusId } = data
            orderStatusNow.innerHTML = `${statusName}`;
            //statusSel.innerHTML = `<option value="${statusId}">${statusName}</option>`
            //console.log(statusId)
            //const statusId = statusSel.options[statusSel.selectedIndex].value;
        }
        $(document).ready(()=>{
        loadStatusNow();
        loadStatusOptions(OrderId);
        })

        const OrderId = $("#orderId").val()
        //statusSel.addEventListener('click', () => {
        //    ;
        //})

           


        async function loadStatusOptions(OrderId) {

            const response = await fetch(`@Url.Content("~/OrderApi/GetOrderStatusOptions?OrderId=")${OrderId}`)//todo
            const data = await response.json()
            let statusSelection = "";
            console.log(data)
            data.map(option => {
                const { statusId, statusName } = option
                statusSelection += `<option value="${statusId}">${statusName}</option>`;
                console.log(statusSelection)
                //return (`<option value="${statusId}">${statusName}</option>`)
            })
            $("#statusSel").html(statusSelection);

        }












    </script>
    }
@section Styles{
    <style>

        .dollar::after {
            content: '$';
        }
    </style>
    }