@model prjOniqueWebsite.Models.Dtos.ProductDetailDto
@{
    ViewData["Title"] = "商品明細";
    Layout = "~/Views/Shared/_Layout_Product.cshtml";
}

<div class="d-flex" id="divContent">
    <div class="w-500-h-500 overflow-hidden rounded " >
        <img src="@Url.Content("~/images/uploads/products/")@Model.products.PhotoPath"  id="productPhoto" />
        <input type="hidden" id="stockId" />
    </div>
    <div class="flex-fill">
        <input type="hidden" value="@Model.products.ProductId" id="productId" />
        <div class="fw-bold fs-4 border-bottom border-secondary p-2">@Model.products.ProductName</div>
        <div class="d-flex gap-2 mt-2">
            <div class="fw-bold p-2 width-90px text-end">商品價格:</div>
            <div class="fw-bold p-2 text-danger" id="price">@Model.products.Price.ToString("0")</div>
        </div>
        <div class="d-flex mt-2 gap-2 align-items-center">
            <div class="fw-bold p-2 width-90px text-end">顏色:</div>
            <div class="fw-bold p-2 d-flex width-120px ">
                <select class="form-select form-select-sm " id="selectColor">
                    <option value=""></option>
                </select>
            </div>
        </div>
        <div class="d-flex mt-2 gap-2 align-items-center">
            <div class="fw-bold p-2 width-90px text-end">尺寸:</div>
            <div class="fw-bold p-2 d-flex width-120px">
                <select class="form-select form-select-sm " id="selectSize">
                </select>
            </div>
        </div>
        <div class="d-flex mt-2 gap-2 align-items-center">
            <div class="fw-bold p-2 width-90px text-end">數量:</div>
            <div class="fw-bold p-2 d-flex ">
                <div class="border border-dark-subtle text-center cursor-pointer" style="width: 25px;" id="btnReduce">-</div>
                <input type="text" value="1" id="orderQty" class="width-50px text-center" />
                <div class="border border-dark-subtle text-center cursor-pointer" style="width: 25px;" id="btnIncrease">+</div>
            </div>
            <div class="fw-bold p-2 width-90px text-end">庫存數量:</div>
            <div class="text-danger"></div>
        </div>
        <div class="d-flex mt-2 gap-2 align-items-center">
            <div class="fw-bold p-2 width-90px text-end">收藏:</div>
            <div class="fw-bold p-2 d-flex ">
                <div class="fw-bold p-2 d-flex width-40px">
                    <img src="~/images/icon/love.png" />
                </div>
            </div>
            <div class="fw-bold p-2 width-90px text-end">分享:</div>
            <div class="fw-bold p-2 d-flex ">
                <div class="fw-bold p-2 d-flex width-40px">
                    <img src="~/images/icon/share.png" />
                </div>
            </div>
        </div>
        <div class="d-flex align-items-center justify-content-center gap-3 mt-4">
            <input type="button" value="立即購買" class="width-120px btn btn-outline-dark" />
            <input type="button" value="加入購物車" class="btn btn-dark width-120px" id="btnAddToCart" />
        </div>
    </div>
</div>

@section Styles{
    <link href="~/css/productDetail.css" rel="stylesheet" />
    <style>
        #price::before {
            content: "$";
        }


    </style>
}

@section Scripts{
    <script>
        const selectColor = document.querySelector("#selectColor");
        const selectSize = document.querySelector("#selectSize");
        const productId = $("#productId").val();

        $("#btnReduce").click(function () {
            let orderQty = Number($("#orderQty").val())
            if (orderQty <= 0) {
                orderQty = 0
                $("#orderQty").val(orderQty.toString());
            }
            else {
                orderQty--
                $("#orderQty").val(orderQty.toString());
            }
        })

        $("#btnIncrease").click(function () {
            let orderQty = Number($("#orderQty").val())
            orderQty++
            $("#orderQty").val(orderQty)
        })
        
        loadColor();

        async function loadColor(){
            const response = await fetch(`@Url.Content("~/productapi/GetStockColor/")${productId}`)
            const datas = await response.json();
            
            const colors = datas.map(color=>{
                const { colorId, colorName }=color;
                return `<option value="${colorId}">${colorName}</option>`
            })
            selectColor.innerHTML = colors.join("")
            loadSize();
        }

        async function loadSize() {
            const colorId = $("#selectColor").val()
            const response = await fetch(`@Url.Content("~/productapi/GetStockSize?")id=${productId}&colorId=${colorId}`)
            const datas = await response.json();

            const sizes = datas.map(size=>{
                const { sizeId , sizeName} = size
                return `<option value="${sizeId}">${sizeName}</option>`
            })
            selectSize.innerHTML = sizes.join("")
            loadProductPhoto()
        }

        selectColor.addEventListener('change',function(){
            loadSize()
        })

        selectSize.addEventListener('change',function(){
            loadProductPhoto()
        })

        async function loadProductPhoto(){
            const colorId = $("#selectColor").val()
            const sizeId = $("#selectSize").val()
            console.log(productId,colorId,sizeId,)
            const response = await fetch(`@Url.Content("~/ProductApi/changeProductPhoto?")productId=${productId}&colorId=${colorId}&sizeId=${sizeId}`)
            const psd = await response.json()
            const { photoPath, stockId }=psd
            $("#productPhoto").attr("src", `@Url.Content("~/images/uploads/products/")${photoPath}`)

            $("#stockId").val(`${stockId}`)
        }

        $('#btnAddToCart').click(function(){
            const stockId = $("#stockId").val()
            const qty = $("#orderQty").val()


        })
    </script>
}